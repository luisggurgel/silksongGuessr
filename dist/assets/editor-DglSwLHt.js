import"./modulepreload-polyfill-B5Qt9EMX.js";const b=[{stateKey:"packName",packKey:"name",label:"Pack Name",type:"text",id:"pack-name",defaultValue:"My New Pack",placeholder:"e.g., My Awesome Pack"},{stateKey:"gameModeId",packKey:"gameModeId",label:"Game Mode ID",type:"text",id:"game-mode-id",defaultValue:"my_new_pack",placeholder:"e.g., my_awesome_pack (no spaces)"},{stateKey:"author",packKey:"author",label:"Author",type:"text",id:"author-name",defaultValue:"",placeholder:"Your name"},{stateKey:"thumbnail",packKey:"thumbnail",label:"Pack Thumbnail",type:"image",id:"pack-thumbnail-upload",defaultValue:null,previewId:"pack-thumbnail-preview",previewDefault:"images/editor/imagePreview.svg",fileName:"thumbnail.png"}],t={locations:[],uploadedFiles:{},selectedLocationId:null,nextLocationId:1,isPlacingNewPin:!1,defaultMapUrl:"images/game/defaultMaps/hallownest.png",customMapFile:null,customMapUrl:"images/game/defaultMaps/hallownest.png",mapImageWidth:4498,mapImageHeight:2901,contributors:[]},r=L.map("map",{crs:L.CRS.Simple,minZoom:-2,maxZoom:2,zoomSnap:.25,zoomDelta:0,scrollWheelZoom:!0,center:[t.mapImageHeight/2,t.mapImageWidth/2],zoom:0,zoomAnimation:!0,attributionControl:!1,zoomControl:!1,maxBoundsViscosity:.5,preferCanvas:!0,renderer:L.canvas()}),G=[[0,0],[t.mapImageHeight,t.mapImageWidth]],w=L.imageOverlay(t.customMapUrl,G).addTo(r);w.on("load",function(){const e=this._image;t.mapImageWidth=e.naturalWidth,t.mapImageHeight=e.naturalHeight;const n=[[0,0],[t.mapImageHeight,t.mapImageWidth]];this.setBounds(n),r.options.minZoom=Math.floor(Math.log(Math.max(r.getSize().x,r.getSize().y)/Math.max(t.mapImageWidth,t.mapImageHeight))/Math.log(2)),r.fitBounds(n),r.setMaxBounds(n),r.invalidateSize()});const R=document.getElementById("sidebar"),U=document.getElementById("pack-settings-container"),C=document.getElementById("locations-list"),y=document.getElementById("add-location-btn"),X=document.getElementById("download-pack-btn"),Y=document.getElementById("import-pack-btn"),F=document.getElementById("import-file-input"),Q=document.getElementById("new-pack-btn"),H=document.getElementById("location-details"),ee=document.getElementById("coord-x"),te=document.getElementById("coord-y"),$=document.getElementById("difficulty-slider"),j=document.getElementById("difficulty-value"),ae=document.getElementById("image-upload"),z=document.getElementById("image-preview"),K=document.getElementById("image-upload-label"),ne=document.getElementById("delete-location-btn"),oe=document.getElementById("close-details-btn"),M=document.getElementById("default-map-selector"),ie=document.getElementById("map-image-upload"),v=document.getElementById("map-image-upload-label"),le=document.getElementById("resizer"),ce=316;let T=0,D=0;le.addEventListener("mousedown",e=>{e.preventDefault(),T=parseFloat(getComputedStyle(R,null).getPropertyValue("width").replace("px","")),D=e.pageX,window.addEventListener("mousemove",_),window.addEventListener("mouseup",O)});function _(e){const n=T-(e.pageX-D);n>ce&&(R.style.width=n+"px")}function O(){window.removeEventListener("mousemove",_),window.removeEventListener("mouseup",O),r.invalidateSize()}ie.addEventListener("change",e=>{const n=e.target.files[0];n&&(t.customMapFile&&t.customMapUrl.startsWith("blob:")&&URL.revokeObjectURL(t.customMapUrl),t.customMapFile=n,t.customMapUrl=URL.createObjectURL(n),w.setUrl(t.customMapUrl),v.textContent=n.name)});y.addEventListener("click",()=>{t.isPlacingNewPin=!0,r.getContainer().style.cursor="crosshair",y.innerText="Click on map to place...",y.disabled=!0});oe.addEventListener("click",()=>{B()});Y.addEventListener("click",()=>{F.click()});Q.addEventListener("click",()=>{de()});function se(){U.innerHTML="",U.innerHTML='<h2 class="section-heading">Pack Details</h2>',b.forEach(e=>{t[e.stateKey]=e.defaultValue;const n=document.createElement("div");n.className="input-group";const a=document.createElement("label");if(a.htmlFor=e.id,a.textContent=e.label,a.className="input-label",e.type==="text"||e.type==="textarea"){const o=document.createElement(e.type==="textarea"?"textarea":"input");e.type!=="textarea"&&(o.type=e.type),o.id=e.id,o.className="text-input",o.placeholder=e.placeholder||"",o.value=e.defaultValue,o.addEventListener("input",l=>{t[e.stateKey]=l.target.value}),n.append(a,o)}else if(e.type==="image"){const o=document.createElement("input");o.type="file",o.id=e.id,o.style.display="none",o.accept=".png, .jpg, .jpeg, .webp, .gif, .svg, .bmp, .tiff, .ico, .heic, .heif";const l=document.createElement("label");l.htmlFor=e.id,l.className="file-label",l.innerHTML=`<span>Upload ${e.label}</span>`;const i=document.createElement("img");i.id=e.previewId,i.src=e.previewDefault,i.alt=`${e.label} Preview`,i.className="preview-img",o.addEventListener("change",u=>{const m=u.target.files[0];m&&(t.uploadedFiles[e.fileName]=m,t[e.stateKey]=`images/${e.fileName}`,i.src=URL.createObjectURL(m),l.querySelector("span").textContent=`Change Thumbnail (${m.name})`)}),n.append(a,l,o,i)}U.appendChild(n)})}async function de(){await me("Are you sure you want to create a new pack? All unsaved changes will be lost.")&&W()}function V(){return`loc-${t.nextLocationId++}`}function W(){t.locations.forEach(e=>{e.marker&&r.removeLayer(e.marker)}),t.customMapFile&&t.customMapUrl.startsWith("blob:")&&URL.revokeObjectURL(t.customMapUrl),b.forEach(e=>{t[e.stateKey]=e.defaultValue}),t.locations=[],t.uploadedFiles={},t.selectedLocationId=null,t.nextLocationId=1,t.isPlacingNewPin=!1,t.defaultMapUrl="images/game/defaultMaps/hallownest.png",t.customMapFile=null,t.customMapUrl=t.defaultMapUrl,t.contributors=[],b.forEach(e=>{const n=document.getElementById(e.id);if(n)if(e.type==="image"){const a=document.getElementById(e.previewId),o=document.querySelector(`label[for="${e.id}"] span`);a&&(a.src=e.previewDefault),o&&(o.textContent=e.label),n.value=""}else n.value=e.defaultValue}),M.value="hallownest.png",v.textContent="Upload Custom Map Image",w.setUrl(t.customMapUrl),B(),h(),y.disabled=!1,y.innerHTML=`
        <img src="images/editor/add.svg" alt="" class="svg-icon">
        Add New Location
    `,r.getContainer().style.cursor="grab"}function h(){if(C.innerHTML="",t.locations.length===0){C.innerHTML=`
            <div class="empty-list-message">
                <p>No locations yet.</p>
                <p>Click "Add New Location" to start placing pins on the map.</p>
            </div>`;return}t.locations.forEach((e,n)=>{const a=document.createElement("div");a.className="location-item",e.id===t.selectedLocationId&&a.classList.add("selected");const o=n+1;a.innerHTML=`
                     <span class="location-item-text">Location #${o}</span>
                     <span class="location-subtext">Diff: ${e.difficulty}</span>
                 `,a.dataset.id=e.id,a.addEventListener("click",()=>{x(e.id)}),C.appendChild(a)})}function Z(e,n){const a=L.divIcon({className:"pin-icon",iconSize:[32,32]}),o=L.marker(n,{icon:a,draggable:!0}).addTo(r);return o.id=e,o.on("click",()=>{x(e)}),o.on("dragend",l=>{const i=l.target.getLatLng(),u=t.locations.find(m=>m.id===e);u&&(u.y=Math.round(i.lat),u.x=Math.round(i.lng),P(),h())}),o}function x(e){t.selectedLocationId=e,r.eachLayer(a=>{a instanceof L.Marker&&a._icon&&a._icon.classList.remove("active")}),document.querySelectorAll(".location-item").forEach(a=>{a.classList.remove("selected")});const n=t.locations.find(a=>a.id===e);if(n){const a=n.marker;a&&a._icon&&a._icon.classList.add("active");const o=document.querySelector(`.location-item[data-id="${e}"]`);o&&o.classList.add("selected"),P(),H.style.display="block",h()}}function B(){t.selectedLocationId=null,H.style.display="none",r.eachLayer(e=>{e instanceof L.Marker&&e._icon&&e._icon.classList.remove("active")}),h()}function P(){const e=t.locations.find(n=>n.id===t.selectedLocationId);if(e)if(ee.textContent=e.x,te.textContent=e.y,$.value=e.difficulty,j.textContent=e.difficulty,e.image){const n=e.image.split("/").pop(),a=t.uploadedFiles[n];a&&(z.src=URL.createObjectURL(a),K.textContent=`Change Image (${a.name})`)}else z.src="https://placehold.co/400x200/1f2937/d1d5db?text=Image+Preview",K.textContent="Upload Location Image"}$.addEventListener("input",e=>{const n=t.locations.find(a=>a.id===t.selectedLocationId);n&&(n.difficulty=e.target.value,j.textContent=n.difficulty,h())});ae.addEventListener("change",e=>{const n=e.target.files[0];if(!n)return;const a=t.locations.find(o=>o.id===t.selectedLocationId);if(a){const o=`${a.id}-${n.name.replace(/[^a-zA-Z0-9.]/g,"_")}`;a.image=`images/${o}`,t.uploadedFiles[o]=n,P()}});ne.addEventListener("click",()=>{const e=t.locations.findIndex(n=>n.id===t.selectedLocationId);if(e>-1){const n=t.locations[e];if(n.marker&&r.removeLayer(n.marker),n.image){const a=n.image.split("/").pop();delete t.uploadedFiles[a]}t.locations.splice(e,1),B()}});M.addEventListener("change",e=>{const n=e.target.value;t.customMapFile=null,t.defaultMapUrl=`images/game/defaultMaps/${n}`,w.setUrl(t.defaultMapUrl)});r.on("click",e=>{if(t.isPlacingNewPin){const n=Math.round(e.latlng.lat),a=Math.round(e.latlng.lng),o=V(),l={id:o,x:a,y:n,difficulty:5,image:null},i=Z(o,e.latlng);l.marker=i,t.locations.push(l),t.isPlacingNewPin=!1,r.getContainer().style.cursor="grab",y.innerHTML=`
                <img src="images/editor/add.svg" alt="" class="svg-icon">
                Add New Location
                `,y.disabled=!1,x(o)}});function re(e){return new Promise(n=>{w.once("load",()=>n()),w.setUrl(e)})}F.addEventListener("change",async e=>{var o,l;const n=e.target.files[0];if(!n)return;const a=g("Importing pack...");try{const i=await JSZip.loadAsync(n),u=i.file("pack.json");if(!u)throw new Error("Invalid pack file: pack.json not found.");const m=await u.async("string"),c=JSON.parse(m);console.log("Imported pack data:",c),W(),b.forEach(d=>{const p=c[d.packKey]||d.defaultValue;t[d.stateKey]=p;const f=document.getElementById(d.id);f&&f.type!=="file"&&(f.value=p)}),c.contributors&&Array.isArray(c.contributors)?t.contributors=c.contributors:t.contributors=[];const s=b.find(d=>d.stateKey==="thumbnail");if(s&&c[s.packKey]){const d=i.file(c[s.packKey]);if(d){const p=await d.async("blob"),f=new File([p],s.fileName);t.uploadedFiles[s.fileName]=f,t[s.stateKey]=c[s.packKey];const k=document.getElementById(s.previewId);k&&(k.src=URL.createObjectURL(f))}}if((o=c.map)!=null&&o.useCustomMap){const d=i.file(c.map.mapImage);if(d){const p=await d.async("blob");t.customMapFile=new File([p],c.map.mapImage,{type:"image/png"}),t.customMapUrl=URL.createObjectURL(t.customMapFile),v.textContent=c.map.mapImage,M.value="hallownest.png"}else console.warn(`Map image '${c.map.mapImage}' not found in zip. Using default map.`),t.customMapFile=null,t.customMapUrl=t.defaultMapUrl,v.textContent="Upload Custom Map Image"}else(l=c.map)!=null&&l.defaultMap?(t.customMapFile=null,t.customMapUrl=c.map.defaultMap,t.defaultMapUrl=c.map.defaultMap,M.value=c.map.defaultMap.split("/").pop(),v.textContent="Upload Custom Map Image"):(t.customMapFile=null,t.customMapUrl=t.defaultMapUrl,v.textContent="Upload Map Image (map.png)");await re(t.customMapUrl);const I=i.folder("images");I&&c.locations&&await Promise.all(c.locations.map(async d=>{const p=d.image.split("/").pop(),f=I.file(p);if(f){const S=await f.async("blob"),J=new File([S],p,{type:S.type});t.uploadedFiles[p]=J}const k=t.mapImageHeight-d.y,N=V(),A={id:N,x:d.x,y:k,difficulty:d.difficulty,image:d.image},q=Z(N,[k,d.x]);A.marker=q,t.locations.push(A)})),h(),E(a),g("Pack imported successfully!",3e3)}catch(i){console.error("Error importing pack:",i),E(a),g("Error importing pack: "+i.message,5e3)}finally{F.value=""}});X.addEventListener("click",async()=>{if(t.locations.length===0){g("Please add at least one location to download a pack.",5e3);return}const e=[];for(const a of t.locations){const o=a.image?a.image.split("/").pop():null;(o?t.uploadedFiles[o]:null)||e.push(a.id)}if(e.length>0){const a=`Please upload an image for the following locations before downloading: <br><br><b>${e.join(", ")}</b>`;g(a,7e3);return}const n=g("Generating and zipping your pack...",0);try{const a={};b.forEach(s=>{a[s.packKey]=t[s.stateKey]}),a.locations=t.locations.map(s=>({x:s.x,y:t.mapImageHeight-s.y,difficulty:s.difficulty,image:s.image})),t.contributors&&t.contributors.length>0&&(a.contributors=t.contributors);const o=new JSZip;t.customMapFile?(o.file("map.png",t.customMapFile),a.map={useCustomMap:!0,mapImage:"map.png"}):a.map={useCustomMap:!1,defaultMap:t.defaultMapUrl},o.file("pack.json",JSON.stringify(a,null,2));const l=o.folder("images"),i=b.find(s=>s.stateKey==="thumbnail");if(i&&t[i.stateKey]&&t.uploadedFiles[i.fileName]){const s=t.uploadedFiles[i.fileName];l.file(i.fileName,s)}for(const s of t.locations){const I=s.image.split("/").pop(),d=t.uploadedFiles[I];l.file(I,d)}const u=await o.generateAsync({type:"blob"}),m=document.createElement("a"),c=URL.createObjectURL(u);m.href=c,m.download=`${t.packName.replace(/\s/g,"")}.zip`,document.body.appendChild(m),m.click(),document.body.removeChild(m),URL.revokeObjectURL(c),E(n),g("Pack downloaded successfully!",3e3)}catch(a){console.error("Error during pack generation:",a),E(n),g("An unexpected error occurred during pack generation.",5e3)}});se();h();window.addEventListener("keydown",e=>{if(e.key!=="ArrowRight"&&e.key!=="ArrowLeft"&&e.key!=="ArrowUp"&&e.key!=="ArrowDown")return;const n=document.activeElement;if(!n||(n.tagName,!t.locations||t.locations.length===0))return;const a=t.locations.findIndex(o=>o.id===t.selectedLocationId);if(e.key==="ArrowRight"||e.key==="ArrowDown"){const o=Math.min(a===-1?0:a+1,t.locations.length-1),l=t.locations[o].id;l!==t.selectedLocationId&&x(l),e.preventDefault()}else if(e.key==="ArrowLeft"||e.key==="ArrowUp"){const o=Math.max(a===-1?t.locations.length-1:a-1,0),l=t.locations[o].id;l!==t.selectedLocationId&&x(l),e.preventDefault()}});function g(e,n=0){const a=document.createElement("div");return a.style.position="fixed",a.style.inset="0",a.style.display="flex",a.style.alignItems="center",a.style.justifyContent="center",a.style.zIndex="2000",a.style.backgroundColor="rgba(0,0,0,0.7)",a.innerHTML=`
                <div style="background-color: #1f2937; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1); text-align: center; max-width: 28rem;">
                    <p style="color: #fff; font-size: 1.125rem;">${e}</p>
                    ${n>0?'<button class="btn btn-primary" style="margin-top: 1rem;" onclick="document.body.removeChild(this.parentElement.parentElement)">Close</button>':""}
                </div>
            `,document.body.appendChild(a),n>0&&setTimeout(()=>{document.body.contains(a)&&document.body.removeChild(a)},n),a}function E(e){e&&document.body.contains(e)&&document.body.removeChild(e)}function me(e){return new Promise(n=>{const a=document.createElement("div");a.style.position="fixed",a.style.inset="0",a.style.display="flex",a.style.alignItems="center",a.style.justifyContent="center",a.style.zIndex="2000",a.style.backgroundColor="rgba(0,0,0,0.7)",a.innerHTML=`
            <div style="background-color: #1f2937; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1); text-align: center; max-width: 28rem;">
                <p style="color: #fff; font-size: 1.125rem; margin-bottom: 1.5rem;">${e}</p>
                <div class="flex-row" style="justify-content: center;">
                    <button id="confirm-dialog-btn" class="btn btn-primary">Confirm</button>
                    <button id="cancel-dialog-btn" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        `,document.body.appendChild(a);const o=a.querySelector("#confirm-dialog-btn"),l=a.querySelector("#cancel-dialog-btn"),i=u=>{document.body.removeChild(a),n(u)};o.addEventListener("click",()=>i(!0)),l.addEventListener("click",()=>i(!1))})}
